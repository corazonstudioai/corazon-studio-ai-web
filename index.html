<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coraz√≥n Studio AI</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#071427; color:#fff; margin:0; padding:24px}
    .wrap{max-width:720px; margin:0 auto}
    .card{background:#0b1b33; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; margin:14px 0}
    h1{margin:0 0 10px 0}
    h2{margin:0 0 10px 0; font-size:18px}
    textarea,input{width:100%; box-sizing:border-box; border-radius:12px; border:1px solid rgba(255,255,255,.12); padding:12px; font-size:16px; background:#ffffff; color:#000}
    button{width:100%; padding:12px 14px; border:none; border-radius:12px; font-size:16px; font-weight:700; background:#2563eb; color:#fff; margin-top:10px}
    button:disabled{opacity:.6}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .pill{padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.08); font-size:13px}
    .muted{opacity:.85; font-size:14px}
    img, video{width:100%; border-radius:14px; margin-top:10px; background:#000}
    .status{margin-top:10px; font-size:14px; opacity:.9}
    .ok{color:#7CFF9B}
    .err{color:#FF7C7C}
    hr{border:none; border-top:1px solid rgba(255,255,255,.1); margin:16px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üé¨ Coraz√≥n Studio AI</h1>
    <div class="pill" id="apiBadge">API: verificando‚Ä¶</div>

    <div class="card">
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      <div class="muted">Tu backend (Render):</div>
      <input id="backendUrl" value="https://corazon-studio-ai-backend-3.onrender.com" />
      <button onclick="saveBackend()">Guardar</button>
      <div class="status" id="cfgStatus"></div>
    </div>

    <div class="card">
      <h2>üí¨ Chat</h2>
      <textarea id="chatInput" rows="3" placeholder="Escribe tu mensaje..."></textarea>
      <button id="chatBtn" onclick="sendChat()">Enviar</button>
      <div class="status" id="chatStatus"></div>
      <div class="card" style="background:#09162a; margin-top:12px;">
        <div class="muted">Respuesta:</div>
        <div id="chatResult" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="card">
      <h2>üñºÔ∏è Im√°genes</h2>
      <textarea id="imgPrompt" rows="3" placeholder='Ej: "Un perrito negro con una ni√±a jugando..."'></textarea>
      <button id="imgBtn" onclick="genImage()">Generar imagen</button>
      <div class="status" id="imgStatus"></div>
      <div id="imgResult"></div>
    </div>

    <div class="card">
      <h2>üéûÔ∏è Generador de Video</h2>
      <textarea id="videoPrompt" rows="4" placeholder="Describe tu video..."></textarea>
      <button id="videoBtn" onclick="genVideo()">Generar video</button>
      <div class="status" id="videoStatus"></div>
      <div id="videoResult"></div>
    </div>

  </div>

<script>
  // ====== Config persistente ======
  const KEY = "corazon_backend_url";
  const backendUrlInput = document.getElementById("backendUrl");
  const apiBadge = document.getElementById("apiBadge");

  function getBackend() {
    return (localStorage.getItem(KEY) || backendUrlInput.value || "").trim().replace(/\/$/, "");
  }

  function saveBackend() {
    const v = backendUrlInput.value.trim().replace(/\/$/, "");
    localStorage.setItem(KEY, v);
    document.getElementById("cfgStatus").textContent = "‚úÖ Guardado";
    checkAPI();
  }

  // ====== Helpers ======
  function setStatus(id, msg, type="") {
    const el = document.getElementById(id);
    el.className = "status " + (type === "ok" ? "ok" : type === "err" ? "err" : "");
    el.textContent = msg || "";
  }

  async function checkAPI() {
    const base = getBackend();
    backendUrlInput.value = base;
    try {
      const r = await fetch(base + "/", { method: "GET" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      apiBadge.textContent = "API: conectada ‚úÖ";
      apiBadge.className = "pill ok";
    } catch (e) {
      apiBadge.textContent = "API: no conecta ‚ùå";
      apiBadge.className = "pill err";
    }
  }

  // ====== Chat ======
  async function sendChat() {
    const base = getBackend();
    const msg = document.getElementById("chatInput").value.trim();
    if (!msg) return setStatus("chatStatus", "Escribe algo primero.", "err");

    const btn = document.getElementById("chatBtn");
    btn.disabled = true;
    setStatus("chatStatus", "Enviando...");

    try {
      const r = await fetch(base + "/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg })
      });
      const data = await r.json();
      document.getElementById("chatResult").textContent = data.reply || "(sin respuesta)";
      setStatus("chatStatus", "‚úÖ Listo", "ok");
    } catch (e) {
      setStatus("chatStatus", "‚ùå Error enviando chat", "err");
    } finally {
      btn.disabled = false;
    }
  }

  // ====== Imagen ======
  async function genImage() {
    const base = getBackend();
    const prompt = document.getElementById("imgPrompt").value.trim();
    if (!prompt) return setStatus("imgStatus", "Escribe un prompt primero.", "err");

    const btn = document.getElementById("imgBtn");
    btn.disabled = true;
    setStatus("imgStatus", "Generando imagen...");
    document.getElementById("imgResult").innerHTML = "";

    try {
      const r = await fetch(base + "/generate-image", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ prompt })
      });
      const data = await r.json();
      if (data.error) throw new Error(data.error);
      if (!data.image_url) throw new Error("Sin image_url");

      document.getElementById("imgResult").innerHTML =
        `<img src="${data.image_url}" alt="Imagen generada" />`;
      setStatus("imgStatus", "‚úÖ Imagen lista", "ok");
    } catch (e) {
      setStatus("imgStatus", "‚ùå Error generando imagen", "err");
    } finally {
      btn.disabled = false;
    }
  }

  // ====== Video (job + polling) ======
  async function genVideo() {
    const base = getBackend();
    const prompt = document.getElementById("videoPrompt").value.trim();
    if (!prompt) return setStatus("videoStatus", "Escribe la descripci√≥n primero.", "err");

    const btn = document.getElementById("videoBtn");
    btn.disabled = true;
    document.getElementById("videoResult").innerHTML = "";
    setStatus("videoStatus", "‚è≥ Iniciando video...");

    try {
      // 1) iniciar job
      const r = await fetch(base + "/generate-video", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ prompt })
      });
      const data = await r.json();
      if (data.error) throw new Error(data.error);

      const jobId = data.job_id;
      if (!jobId) throw new Error("No lleg√≥ job_id");

      // 2) polling
      setStatus("videoStatus", "‚è≥ Generando video (puede tardar 20‚Äì60s)...");

      const started = Date.now();
      const MAX_MS = 120000; // 2 min m√°ximo para no quedar pegado
      const interval = setInterval(async () => {
        try {
          if (Date.now() - started > MAX_MS) {
            clearInterval(interval);
            setStatus("videoStatus", "‚ùå Se tard√≥ demasiado. Intenta otra vez (Render puede estar dormido).", "err");
            btn.disabled = false;
            return;
          }

          const s = await fetch(base + "/video-status/" + jobId);
          const statusData = await s.json();

          if (statusData.status === "done" && statusData.video_url) {
            clearInterval(interval);
            document.getElementById("videoResult").innerHTML = `
              <video controls playsinline>
                <source src="${statusData.video_url}" type="video/mp4" />
              </video>
            `;
            setStatus("videoStatus", "‚úÖ Video listo", "ok");
            btn.disabled = false;
          } else if (statusData.status === "not_found") {
            // si se reinici√≥ el server, puede pasar
            setStatus("videoStatus", "‚è≥ Esperando... (servidor reinici√≥). Vuelve a intentar.", "err");
            clearInterval(interval);
            btn.disabled = false;
          }
        } catch (e) {
          // si falla un tick, no matamos todo
        }
      }, 3000);

    } catch (e) {
      setStatus("videoStatus", "‚ùå Error iniciando video", "err");
      btn.disabled = false;
    }
  }

  // init
  (function init(){
    const saved = localStorage.getItem(KEY);
    if (saved) backendUrlInput.value = saved;
    checkAPI();
  })();
</script>
</body>
</html>

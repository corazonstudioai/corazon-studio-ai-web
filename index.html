<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coraz√≥n Studio AI</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 18px; background:#f7f7f9; color:#111; }
    .container { max-width: 920px; margin: 0 auto; }
    h1 { margin: 6px 0 18px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius: 14px; padding: 14px; margin: 12px 0; box-shadow: 0 1px 10px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    input, textarea, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #d7d7e6; font-size: 16px; }
    textarea { min-height: 90px; resize: vertical; }
    button { padding: 12px 14px; border-radius: 12px; border: 0; cursor: pointer; background:#2563eb; color: #fff; font-weight: 700; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color:#666; font-size: 14px; }
    .ok { background:#e8fff0; border:1px solid #b7f0c8; color:#0f5132; padding: 10px 12px; border-radius: 12px; margin-top: 10px; }
    .err { background:#fff0f0; border:1px solid #ffcccc; color:#7a1b1b; padding: 10px 12px; border-radius: 12px; margin-top: 10px; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; word-break: break-word; background:#0b1220; color:#dbeafe; padding: 12px; border-radius: 12px; }
    img { max-width: 100%; border-radius: 14px; border:1px solid #eee; }
    video { width: 100%; border-radius: 14px; border:1px solid #eee; background:#000; }
    .small { font-size: 13px; }
    .pill { display:inline-block; padding:4px 10px; border-radius: 999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size: 12px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Coraz√≥n Studio AI <span class="pill">Web</span></h1>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted">Backend</div>
          <div id="apiBaseLabel" class="small"></div>
        </div>
        <button id="btnHealth">Probar /health</button>
      </div>
      <div id="healthOut"></div>
    </div>

    <!-- CHAT -->
    <div class="card">
      <h2>üí¨ Chat</h2>
      <textarea id="chatInput" placeholder="Escribe tu mensaje..."></textarea>
      <div class="row" style="margin-top:10px;">
        <button id="btnChat">Enviar</button>
      </div>
      <div id="chatOut" style="margin-top:10px;"></div>
    </div>

    <!-- IMAGEN -->
    <div class="card">
      <h2>üñºÔ∏è Im√°genes</h2>
      <input id="imgPrompt" placeholder="Describe la imagen (ej: un perrito negro con una ni√±a jugando, estilo realista)" />
      <div class="row" style="margin-top:10px;">
        <select id="imgSize" style="max-width: 220px;">
          <option value="1024x1024">1024x1024</option>
          <option value="1024x1536">1024x1536</option>
          <option value="1536x1024">1536x1024</option>
        </select>
        <button id="btnImg">Generar imagen</button>
      </div>

      <div id="imgMsg" style="margin-top:10px;"></div>
      <div id="imgOut" style="margin-top:10px;"></div>
      <div class="muted" style="margin-top:8px;">Si no aparece la imagen, te muestro el error exacto abajo.</div>
      <div id="imgDebug" style="margin-top:10px;"></div>
    </div>

    <!-- VIDEO -->
    <div class="card">
      <h2>üé¨ Video</h2>
      <input id="vidPrompt" placeholder="Describe el video que quieres..." />
      <div class="row" style="margin-top:10px;">
        <button id="btnVid">Generar video</button>
      </div>
      <div id="vidMsg" style="margin-top:10px;"></div>
      <div id="vidOut" style="margin-top:10px;"></div>
      <div id="vidDebug" style="margin-top:10px;"></div>
    </div>

  </div>

  <script>
    // ‚úÖ CAMBIA SOLO ESTO si tu backend tiene otra URL:
    const API_BASE = "https://corazon-studio-ai-backend-3.onrender.com";

    // UI
    const apiBaseLabel = document.getElementById("apiBaseLabel");
    apiBaseLabel.textContent = API_BASE;

    const healthOut = document.getElementById("healthOut");
    const btnHealth = document.getElementById("btnHealth");

    const chatInput = document.getElementById("chatInput");
    const btnChat = document.getElementById("btnChat");
    const chatOut = document.getElementById("chatOut");

    const imgPrompt = document.getElementById("imgPrompt");
    const imgSize = document.getElementById("imgSize");
    const btnImg = document.getElementById("btnImg");
    const imgOut = document.getElementById("imgOut");
    const imgMsg = document.getElementById("imgMsg");
    const imgDebug = document.getElementById("imgDebug");

    const vidPrompt = document.getElementById("vidPrompt");
    const btnVid = document.getElementById("btnVid");
    const vidMsg = document.getElementById("vidMsg");
    const vidOut = document.getElementById("vidOut");
    const vidDebug = document.getElementById("vidDebug");

    function setHtml(el, html) { el.innerHTML = html || ""; }
    function okBox(msg) { return `<div class="ok">‚úÖ ${escapeHtml(msg)}</div>`; }
    function errBox(msg) { return `<div class="err">‚ùå ${escapeHtml(msg)}</div>`; }
    function codeBox(obj) { return `<div class="code">${escapeHtml(typeof obj === "string" ? obj : JSON.stringify(obj, null, 2))}</div>`; }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function apiGet(path) {
      const r = await fetch(`${API_BASE}${path}`, { method: "GET" });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }
      if (!r.ok) throw { status: r.status, data };
      return data;
    }

    async function apiPost(path, body) {
      const r = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }
      if (!r.ok) throw { status: r.status, data };
      return data;
    }

    // ---- HEALTH ----
    btnHealth.addEventListener("click", async () => {
      btnHealth.disabled = true;
      setHtml(healthOut, "");
      try {
        const data = await apiGet("/health");
        setHtml(healthOut, okBox("Backend est√° vivo ‚úÖ") + codeBox(data));
      } catch (e) {
        setHtml(healthOut, errBox(`Error en /health (status ${e?.status ?? "?"})`) + codeBox(e?.data ?? e));
      } finally {
        btnHealth.disabled = false;
      }
    });

    // ---- CHAT ----
    btnChat.addEventListener("click", async () => {
      const message = (chatInput.value || "").trim();
      if (!message) return setHtml(chatOut, errBox("Escribe un mensaje primero."));
      btnChat.disabled = true;
      setHtml(chatOut, okBox("Enviando..."));
      try {
        // Ajustado a lo t√≠pico: { message }
        const data = await apiPost("/chat", { message });
        // Soporta varias formas: {text}, {output}, {message}
        const text =
          data?.text ??
          data?.output_text ??
          data?.output ??
          data?.message ??
          JSON.stringify(data);

        setHtml(chatOut, okBox("Respuesta:") + `<div class="card" style="border-radius:12px; margin-top:10px;">${escapeHtml(text)}</div>`);
      } catch (e) {
        setHtml(chatOut, errBox(`Error en /chat (status ${e?.status ?? "?"})`) + codeBox(e?.data ?? e));
      } finally {
        btnChat.disabled = false;
      }
    });

    // ---- IMAGEN ----
    function normalizeImageToDataUrl(imgObjOrString) {
      // Acepta:
      // - "data:image/png;base64,...."
      // - base64 puro "iVBORw0KGgo...."
      // - { data: "data:image/..." } o { data: "base64..." , mime_type: "image/png" }
      // - { url: "https://..." }
      if (!imgObjOrString) return null;

      if (typeof imgObjOrString === "string") {
        if (imgObjOrString.startsWith("data:image/")) return imgObjOrString;
        // base64 puro (asumimos png)
        return `data:image/png;base64,${imgObjOrString}`;
      }

      const url = imgObjOrString.url || imgObjOrString.href;
      if (url && typeof url === "string") return url;

      const data = imgObjOrString.data;
      if (typeof data === "string") {
        if (data.startsWith("data:image/")) return data;
        const mime = imgObjOrString.mime_type || imgObjOrString.mime || "image/png";
        return `data:${mime};base64,${data}`;
      }

      return null;
    }

    btnImg.addEventListener("click", async () => {
      const prompt = (imgPrompt.value || "").trim();
      const size = imgSize.value;
      if (!prompt) return setHtml(imgMsg, errBox("Escribe una descripci√≥n primero."));
      btnImg.disabled = true;

      setHtml(imgMsg, okBox("Generando imagen..."));
      setHtml(imgOut, "");
      setHtml(imgDebug, "");

      try {
        const data = await apiPost("/image", { prompt, size });

        // Esperado: { ok:true, image:{data:"...", mime_type:"..."} } o variaciones
        const imgCandidate = data?.image ?? data?.data ?? data?.result ?? data;
        const dataUrl = normalizeImageToDataUrl(imgCandidate);

        if (!dataUrl) {
          setHtml(imgMsg, errBox("Respuesta recibida, pero no encontr√© la imagen. Mira el debug."));
          setHtml(imgDebug, codeBox(data));
        } else {
          setHtml(imgMsg, okBox("¬°Imagen lista! ‚úÖ"));
          setHtml(imgOut, `<img alt="Imagen generada" src="${dataUrl}">`);
          // debug opcional (por si algo falla luego)
          setHtml(imgDebug, `<div class="muted small">Debug (por si lo necesitas):</div>` + codeBox(data));
        }
      } catch (e) {
        setHtml(imgMsg, errBox(`Error en /image (status ${e?.status ?? "?"})`));
        setHtml(imgDebug, codeBox(e?.data ?? e));
      } finally {
        btnImg.disabled = false;
      }
    });

    // ---- VIDEO ----
    // Esto intenta:
    // 1) POST /video {prompt}
    // 2) Si devuelve {video_id} o {id}, hace polling a GET /video/{id}
    // 3) Si existe /video/{id}/content, lo intenta cargar como blob
    async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    btnVid.addEventListener("click", async () => {
      const prompt = (vidPrompt.value || "").trim();
      if (!prompt) return setHtml(vidMsg, errBox("Escribe una descripci√≥n primero."));
      btnVid.disabled = true;

      setHtml(vidMsg, okBox("Iniciando video..."));
      setHtml(vidOut, "");
      setHtml(vidDebug, "");

      try {
        const start = await apiPost("/video", { prompt });

        const videoId = start?.video_id ?? start?.id ?? start?.video?.id;
        setHtml(vidDebug, `<div class="muted small">Debug start:</div>` + codeBox(start));

        if (!videoId) {
          setHtml(vidMsg, errBox("No recib√≠ video_id. Mira debug."));
          return;
        }

        setHtml(vidMsg, okBox(`Video iniciado. ID: ${videoId}. Esperando estado...`));

        // Poll status
        let statusData = null;
        for (let i = 0; i < 30; i++) {
          await sleep(4000);
          try {
            statusData = await apiGet(`/video/${encodeURIComponent(videoId)}`);
          } catch (e) {
            // Si falla el status, seguimos intentando un poco
            statusData = { error: e };
          }

          const status =
            statusData?.status ??
            statusData?.state ??
            statusData?.video_status ??
            statusData?.video?.status;

          setHtml(vidDebug, `<div class="muted small">Debug status:</div>` + codeBox(statusData));

          if (status && String(status).toLowerCase().includes("failed")) {
            setHtml(vidMsg, errBox("El video fall√≥. Mira debug."));
            return;
          }

          if (status && (String(status).toLowerCase().includes("done") || String(status).toLowerCase().includes("completed") || String(status).toLowerCase().includes("ready"))) {
            break;
          }

          // si el backend devuelve una URL directa
          const url = statusData?.url ?? statusData?.video_url ?? statusData?.video?.url;
          if (url) {
            setHtml(vidMsg, okBox("Video listo ‚úÖ"));
            setHtml(vidOut, `<video controls src="${url}"></video>`);
            return;
          }
        }

        // Intentar content endpoint
        setHtml(vidMsg, okBox("Intentando descargar contenido del video..."));
        const contentUrl = `${API_BASE}/video/${encodeURIComponent(videoId)}/content`;

        const r = await fetch(contentUrl, { method: "GET" });
        if (!r.ok) {
          const t = await r.text();
          setHtml(vidMsg, errBox("No pude obtener el contenido del video. Mira debug."));
          setHtml(vidDebug, `<div class="muted small">Respuesta /content:</div>` + codeBox(t));
          return;
        }

        const blob = await r.blob();
        const objectUrl = URL.createObjectURL(blob);

        setHtml(vidMsg, okBox("Video listo ‚úÖ"));
        setHtml(vidOut, `<video controls src="${objectUrl}"></video>`);
      } catch (e) {
        setHtml(vidMsg, errBox(`Error en /video (status ${e?.status ?? "?"})`));
        setHtml(vidDebug, codeBox(e?.data ?? e));
      } finally {
        btnVid.disabled = false;
      }
    });
  </script>
</body>
</html>

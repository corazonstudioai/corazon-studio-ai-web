<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coraz√≥n Studio AI</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#071224;color:#fff}
    .wrap{max-width:720px;margin:0 auto;padding:18px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:34px;margin:10px 0 4px}
    .pill{display:inline-flex;gap:10px;align-items:center;background:rgba(0,0,0,.35);padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}
    label{display:block;margin:10px 0 6px;opacity:.9}
    input, textarea, select{width:100%;box-sizing:border-box;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);color:#fff;padding:12px 12px;font-size:16px;outline:none}
    textarea{min-height:88px;resize:vertical}
    button{width:100%;padding:14px 12px;border:0;border-radius:14px;background:#2f6fff;color:#fff;font-size:18px;font-weight:700;cursor:pointer;margin-top:10px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:#7CFF9A;margin-top:8px}
    .err{color:#ff8a8a;margin-top:8px;white-space:pre-wrap}
    .row{display:flex;gap:12px}
    .row > div{flex:1}
    video, img{width:100%;border-radius:14px;margin-top:10px;background:#000}
    .small{opacity:.8;font-size:13px;margin-top:6px}
    a{color:#9cc3ff}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>üé¨ Coraz√≥n Studio AI</h1>
    <div class="pill" id="apiPill">API: conectando‚Ä¶</div>

    <div class="card">
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      <label>Tu backend (Render):</label>
      <input id="backendUrl" placeholder="https://tu-backend.onrender.com" />
      <button id="saveBtn">Guardar</button>
      <div id="saveMsg" class="small"></div>
    </div>

    <div class="card">
      <h2>üí¨ Chat</h2>
      <textarea id="chatMsg" placeholder="Escribe tu mensaje..."></textarea>
      <button id="chatBtn">Enviar</button>
      <div id="chatOut" class="card" style="margin-top:12px;display:none"></div>
    </div>

    <div class="card">
      <h2>üñºÔ∏è Im√°genes</h2>
      <textarea id="imgPrompt" placeholder='Ej: "Un perrito negro con una ni√±a jugando..."'></textarea>
      <button id="imgBtn">Generar imagen</button>
      <div id="imgStatus" class="small"></div>
      <img id="imgResult" alt="Imagen generada" style="display:none" />
      <div id="imgErr" class="err"></div>
    </div>

    <div class="card">
      <h2>üéûÔ∏è Generador de Video</h2>

      <label>Modo de video:</label>
      <select id="videoMode">
        <option value="reels">Modo A: Reels (texto animado + fondo suave)</option>
        <option value="realista">Modo B: Realista (IA: Runway / Pika)</option>
      </select>

      <div id="reelsBox" style="margin-top:10px">
        <label>Texto del reels:</label>
        <textarea id="reelsText" placeholder='Ej: "Dios nunca llega tarde, llega justo a tiempo"'></textarea>

        <div class="row">
          <div>
            <label>Duraci√≥n (seg):</label>
            <input id="reelsSeconds" type="number" value="6" min="3" max="20" />
          </div>
          <div>
            <label>Formato:</label>
            <select id="reelsRatio">
              <option value="1080x1920">9:16 (Reels)</option>
              <option value="1920x1080">16:9</option>
              <option value="1080x1080">1:1</option>
            </select>
          </div>
        </div>

        <button id="reelsBtn">Generar video (Reels)</button>
        <div id="reelsMsg" class="small"></div>
        <video id="reelsVideo" controls playsinline style="display:none"></video>
        <div id="reelsDownload" class="small"></div>
      </div>

      <div id="realBox" style="margin-top:10px;display:none">
        <label>Proveedor IA:</label>
        <select id="provider">
          <option value="runway">Runway (text_to_video)</option>
          <option value="pika">Pika (via Fal.ai)</option>
        </select>

        <label>Describe tu video:</label>
        <textarea id="videoPrompt" placeholder='Ej: "Un perrito feliz corriendo en un parque, estilo realista, luz c√°lida, c√°mara suave"'></textarea>

        <div class="row">
          <div>
            <label>Ratio:</label>
            <select id="videoRatio">
              <option value="1080:1920">9:16</option>
              <option value="1920:1080">16:9</option>
              <option value="1280:720">1280:720</option>
              <option value="720:1280">720:1280</option>
            </select>
          </div>
          <div>
            <label>Duraci√≥n:</label>
            <input id="videoSeconds" type="number" value="5" min="4" max="10" />
          </div>
        </div>

        <button id="videoBtn">Generar video (IA)</button>
        <div id="videoMsg" class="small"></div>
        <video id="videoResult" controls playsinline style="display:none"></video>
        <div id="videoErr" class="err"></div>
      </div>

      <div class="small">
        Nota: el modo <b>Reels</b> siempre se ve limpio (no IA). El modo <b>Realista</b> depende del prompt y del modelo.
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  const $ = (id) => document.getElementById(id);

  function getBackend() {
    return localStorage.getItem("CS_BACKEND") || "";
  }

  function setBackend(url) {
    localStorage.setItem("CS_BACKEND", url);
  }

  function normalizeUrl(u){
    if(!u) return "";
    u = u.trim();
    if(u.endsWith("/")) u = u.slice(0,-1);
    return u;
  }

  async function api(path, options = {}) {
    const base = normalizeUrl(getBackend());
    if(!base) throw new Error("Primero guarda tu backend en Configuraci√≥n.");
    const res = await fetch(base + path, {
      headers: { "Content-Type": "application/json", ...(options.headers||{}) },
      ...options,
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
    if(!res.ok) throw new Error(data.detail || data.raw || "Error API");
    return data;
  }

  // -----------------------------
  // Init
  // -----------------------------
  $("backendUrl").value = getBackend();

  async function ping() {
    try {
      const base = normalizeUrl(getBackend());
      if(!base) { $("apiPill").textContent = "API: no configurada"; return; }
      const r = await fetch(base + "/");
      $("apiPill").textContent = r.ok ? "API: conectada ‚úÖ" : "API: error ‚ùå";
    } catch(e) {
      $("apiPill").textContent = "API: desconectada ‚ùå";
    }
  }
  ping();

  $("saveBtn").onclick = async () => {
    const url = normalizeUrl($("backendUrl").value);
    setBackend(url);
    $("saveMsg").textContent = url ? "‚úÖ Guardado" : "‚ùå Vac√≠o";
    await ping();
  };

  // -----------------------------
  // Chat
  // -----------------------------
  $("chatBtn").onclick = async () => {
    $("chatOut").style.display = "none";
    const message = $("chatMsg").value.trim();
    if(!message) return;
    try{
      const data = await api("/chat", { method:"POST", body: JSON.stringify({message}) });
      $("chatOut").style.display = "block";
      $("chatOut").textContent = data.reply || "(sin respuesta)";
    }catch(e){
      $("chatOut").style.display = "block";
      $("chatOut").textContent = "Error: " + e.message;
    }
  };

  // -----------------------------
  // Imagen (ARREGLADO: ahora s√≠ muestra <img src=URL>)
  // -----------------------------
  $("imgBtn").onclick = async () => {
    $("imgErr").textContent = "";
    $("imgStatus").textContent = "‚è≥ Generando...";
    $("imgResult").style.display = "none";

    const prompt = $("imgPrompt").value.trim();
    if(!prompt){ $("imgStatus").textContent="Escribe un prompt."; return; }

    try{
      const data = await api("/image", { method:"POST", body: JSON.stringify({prompt}) });
      const url = data.url;
      if(!url) throw new Error("La API no devolvi√≥ url de imagen.");

      $("imgResult").src = url;
      $("imgResult").style.display = "block";
      $("imgStatus").textContent = "‚úÖ Imagen lista";
    }catch(e){
      $("imgStatus").textContent = "";
      $("imgErr").textContent = "Error: " + e.message;
    }
  };

  // -----------------------------
  // Toggle video mode UI
  // -----------------------------
  $("videoMode").onchange = () => {
    const v = $("videoMode").value;
    $("reelsBox").style.display = v === "reels" ? "block" : "none";
    $("realBox").style.display = v === "realista" ? "block" : "none";
  };

  // -----------------------------
  // VIDEO MODO A: Reels (Canvas + MediaRecorder)
  // Genera un WEBM (la mayor√≠a de Android lo reproduce)
  // -----------------------------
  $("reelsBtn").onclick = async () => {
    $("reelsMsg").textContent = "";
    $("reelsVideo").style.display = "none";
    $("reelsDownload").innerHTML = "";

    const text = $("reelsText").value.trim();
    if(!text){ $("reelsMsg").textContent = "Escribe el texto del reels."; return; }

    const seconds = Math.max(3, Math.min(20, parseInt($("reelsSeconds").value || "6", 10)));
    const size = $("reelsRatio").value;

    let W=1080, H=1920;
    if(size === "1920x1080"){ W=1920; H=1080; }
    if(size === "1080x1080"){ W=1080; H=1080; }

    // Canvas
    const canvas = document.createElement("canvas");
    canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext("2d");

    // Capture stream
    const stream = canvas.captureStream(30);
    const chunks = [];
    const rec = new MediaRecorder(stream, { mimeType: "video/webm;codecs=vp9" });

    rec.ondataavailable = (e) => { if(e.data.size) chunks.push(e.data); };
    rec.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);

      $("reelsVideo").src = url;
      $("reelsVideo").style.display = "block";
      $("reelsMsg").textContent = "‚úÖ Video listo (WEBM).";

      const a = document.createElement("a");
      a.href = url;
      a.download = "reels.webm";
      a.textContent = "‚¨áÔ∏è Descargar video";
      $("reelsDownload").appendChild(a);
    };

    // Animaci√≥n
    const start = performance.now();
    rec.start();

    function draw(t){
      const elapsed = (t - start)/1000;
      const p = Math.min(1, elapsed / seconds);

      // fondo suave (degradado)
      const g = ctx.createLinearGradient(0,0,W,H);
      g.addColorStop(0, "#1b3a6b");
      g.addColorStop(1, "#0a1428");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);

      // texto animado (entrada y peque√±o zoom)
      const lines = wrapText(ctx, text, Math.floor(W*0.78), "bold 88px system-ui");
      const yCenter = H/2;
      const alpha = p < 0.15 ? (p/0.15) : (p > 0.9 ? ((1-p)/0.1) : 1);
      const scale = 0.92 + 0.08*Math.sin(p*Math.PI);

      ctx.save();
      ctx.globalAlpha = Math.max(0, Math.min(1, alpha));
      ctx.translate(W/2, yCenter);
      ctx.scale(scale, scale);

      // caja suave detr√°s del texto
      const boxW = W*0.86, boxH = lines.length*110 + 90;
      roundRect(ctx, -boxW/2, -boxH/2, boxW, boxH, 28);
      ctx.fillStyle = "rgba(255,255,255,0.10)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 4;
      ctx.stroke();

      // texto
      ctx.fillStyle = "rgba(255,255,255,0.96)";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "bold 88px system-ui";

      const totalH = lines.length*110;
      lines.forEach((ln, i) => {
        const y = (i*110) - (totalH/2) + 55;
        ctx.fillText(ln, 0, y);
      });

      ctx.restore();

      if(elapsed < seconds){
        requestAnimationFrame(draw);
      }else{
        rec.stop();
      }
    }
    requestAnimationFrame(draw);
  };

  function wrapText(ctx, text, maxWidth, font){
    ctx.font = font;
    const words = text.split(/\s+/);
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? (line + " " + w) : w;
      const width = ctx.measureText(test).width;
      if(width > maxWidth && line){
        lines.push(line);
        line = w;
      }else{
        line = test;
      }
    }
    if(line) lines.push(line);
    return lines;
  }

  function roundRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  // -----------------------------
  // VIDEO MODO B: Realista (IA)
  // -----------------------------
  $("videoBtn").onclick = async () => {
    $("videoErr").textContent = "";
    $("videoMsg").textContent = "‚è≥ Iniciando...";
    $("videoResult").style.display = "none";

    const provider = $("provider").value;
    const prompt = $("videoPrompt").value.trim();
    const ratio = $("videoRatio").value;
    const duration = parseInt($("videoSeconds").value || "5", 10);

    if(!prompt){ $("videoMsg").textContent = "Escribe la descripci√≥n del video."; return; }

    try{
      const start = await api("/video/realistic/start", {
        method:"POST",
        body: JSON.stringify({ provider, prompt, ratio, duration })
      });

      const jobId = start.job_id;
      $("videoMsg").textContent = "‚è≥ Generando... (esto puede tardar un poco)";

      // poll
      for(let i=0; i<60; i++){
        await new Promise(r => setTimeout(r, 3000));
        const st = await api("/video/realistic/status/" + jobId, { method:"GET" });

        if(st.status === "DONE" && st.video_url){
          $("videoResult").src = st.video_url;
          $("videoResult").style.display = "block";
          $("videoMsg").textContent = "‚úÖ Video listo";
          return;
        }
        if(st.status === "ERROR"){
          $("videoMsg").textContent = "";
          $("videoErr").textContent = "Error: " + JSON.stringify(st.detail || st, null, 2);
          return;
        }
      }

      $("videoMsg").textContent = "‚è≥ Sigue generando‚Ä¶ vuelve a intentar en 1 minuto.";
    }catch(e){
      $("videoMsg").textContent = "";
      $("videoErr").textContent = "Error: " + e.message;
    }
  };
</script>
</body>
</html>
